<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Refer Approval</title>
<style>
body{margin:0;font-family:Arial;background:#f2f2f2}
.header{padding:15px;background:#020617;color:#1abc9c;font-size:20px}
.container{padding:15px}
.card{background:#fff;border-radius:8px;padding:12px;margin-bottom:10px}
button{padding:6px 12px;border:none;border-radius:4px;background:#22c55e;cursor:pointer}
</style>
</head>
<body>

<div class="header">ðŸ‘‘ Refer Approval</div>
<div class="container" id="list">Loading...</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { 
  getFirestore, collection, query, where, getDocs, 
  updateDoc, doc, getDoc 
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyBFsTzlRPoWHVXEHbKrPdwxslxZGa7Kqfw",
  projectId:"biniyog-95d00"
});
const auth = getAuth(app);
const db = getFirestore(app);
const list = document.getElementById("list");

onAuthStateChanged(auth, async(user)=>{
  if(!user || user.email!=="admin@biniyog.com"){
    location.href="index.html"; return;
  }
  load();
});

async function load(){
  list.innerHTML="";
  const q = query(collection(db,"refer_commissions"), where("status","==","pending"));
  const snap = await getDocs(q);
  if(snap.empty){list.innerHTML="No pending refer";return;}
  snap.forEach(d=>{
    const r=d.data();
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <b>à§³ ${r.amount}</b><br>
      Referrer UID: ${r.referrerUid}<br><br>
      <button onclick="approve('${d.id}','${r.referrerUid}',${r.amount})">Approve</button>
    `;
    list.appendChild(div);
  });
}

window.approve = async(id,uid,amt)=>{
  const uref = doc(db,"users",uid);
  const usnap = await getDoc(uref);
  const bal = usnap.data().balance || 0;

  await updateDoc(uref,{ balance: bal + amt });
  await updateDoc(doc(db,"refer_commissions",id),{ status:"approved" });

  alert("Approved & Balance Updated");
  load();
};
</script>
</body>
</html>
