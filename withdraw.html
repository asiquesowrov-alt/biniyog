<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<title>Biniyog | Withdraw</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:'Hind Siliguri',sans-serif;
  background:#f2f4f7;
}
.header{
  background:#0f172a;
  color:#22c55e;
  padding:15px;
  text-align:center;
  font-size:20px;
  font-weight:600;
}
.container{
  padding:20px;
}
.card{
  background:#fff;
  border-radius:12px;
  padding:20px;
  box-shadow:0 4px 10px rgba(0,0,0,.08);
}
.balance{
  font-size:18px;
  margin-bottom:15px;
}
input,select{
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:8px;
  border:1px solid #ddd;
  font-size:15px;
}
button{
  width:100%;
  padding:12px;
  margin-top:15px;
  background:#22c55e;
  color:#fff;
  border:none;
  border-radius:10px;
  font-size:16px;
  cursor:pointer;
}
button:disabled{
  background:#94a3b8;
}
.note{
  margin-top:10px;
  font-size:13px;
  color:#666;
  text-align:center;
}
.back{
  margin-top:15px;
  text-align:center;
}
.back a{
  color:#0f172a;
  text-decoration:none;
  font-weight:500;
}
</style>
</head>

<body>

<div class="header">üí∏ Withdraw Request</div>

<div class="container">
  <div class="card">

    <div class="balance">
      ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: ‡ß≥ <span id="balance">0</span>
    </div>

    <input type="text" id="mobile" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞">

    <select id="method">
      <option value="">Payment Method ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
      <option value="Bkash">Bkash</option>
      <option value="Nagad">Nagad</option>
      <option value="Rocket">Rocket</option>
    </select>

    <input type="number" id="amount" placeholder="Withdraw Amount">

    <button id="submitBtn">Withdraw Submit</button>

    <div class="note">
      Withdraw ‡¶∏‡¶´‡¶≤ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶´‡ßã‡¶® ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® 
    </div>

    <div class="back">
      <a href="dashboard.html">‚Üê Back to Dashboard</a>
    </div>

  </div>
</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { 
  getFirestore,doc,getDoc,addDoc,
  collection,serverTimestamp 
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyBFsTzlRPoWHVXEHbKrPdwxslxZGa7Kqfw",
  authDomain: "biniyog-95d00.firebaseapp.com",
  projectId: "biniyog-95d00"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let currentBalance = 0;

const balanceEl = document.getElementById("balance");
const submitBtn = document.getElementById("submitBtn");

/* Auth + Load Balance */
onAuthStateChanged(auth, async(user)=>{
  if(!user){
    location.href="login.html";
    return;
  }

  currentUser = user;

  const snap = await getDoc(doc(db,"users",user.uid));
  if(snap.exists()){
    currentBalance = snap.data().balance || 0;
    balanceEl.innerText = currentBalance;
  }
});

/* Submit Withdraw */
submitBtn.onclick = async ()=>{
  const mobile = document.getElementById("mobile").value.trim();
  const method = document.getElementById("method").value;
  const amount = Number(document.getElementById("amount").value);

  if(!mobile || !method || amount <= 0){
    alert("‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®");
    return;
  }

  if(amount > currentBalance){
    alert("‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶®‡ßá‡¶á");
    return;
  }

  submitBtn.disabled = true;

  try{
    // Withdraw request
    await addDoc(collection(db,"withdraws"),{
      uid: currentUser.uid,
      mobile,
      method,
      amount,
      status:"pending",
      createdAt: serverTimestamp()
    });

    // Transaction history
    await addDoc(collection(db,"transactions"),{
      uid: currentUser.uid,
      type:"withdraw",
      amount,
      status:"pending",
      method,
      createdAt: serverTimestamp()
    });

    alert("Withdraw request ‡¶∏‡¶´‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ Transaction history ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
    location.href = "transaction.html";

  }catch(err){
    alert("Transaction history ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®");
    submitBtn.disabled = false;
  }
};
</script>

</body>
</html>
